"""
Test script for performance evaluation tools

This script tests the basic functionality of the performance profiler and analyzer.
"""

import sys
import os
import time
import random

# Add parent directory to path
sys.path.insert(0, os.path.dirname(__file__))

from system_profiler import SystemProfiler


def test_system_profiler():
    """Test basic profiler functionality"""
    print("\n" + "="*80)
    print("Testing System Profiler")
    print("="*80)
    
    profiler = SystemProfiler()
    
    # Simulate some operations
    print("\nSimulating operations...")
    
    # Data ingestion
    for i in range(5):
        with profiler.start_operation('data_ingestion', 'vad_filter') as ctx:
            time.sleep(0.05 + random.random() * 0.05)
            ctx.set_audio_duration(5.0)
            ctx.set_metadata({
                'iteration': i,
                'frames_processed': 100 + i*10
            })
    
    # Feature extraction
    for i in range(5):
        with profiler.start_operation('feature_extraction', 'compute_f0') as ctx:
            time.sleep(0.1 + random.random() * 0.1)
            ctx.set_audio_duration(5.0)
        
        with profiler.start_operation('feature_extraction', 'compute_energy') as ctx:
            time.sleep(0.03 + random.random() * 0.03)
            ctx.set_audio_duration(5.0)
    
    # User profiling
    for i in range(3):
        with profiler.start_operation('user_profiling', 'speaker_recognition') as ctx:
            time.sleep(0.5 if i == 0 else 0.1)  # First call slower
            ctx.set_audio_duration(5.0)
    
    # Print summary
    print("\n" + "-"*80)
    profiler.print_summary()
    
    # Export results
    csv_file = profiler.export_csv('test_metrics.csv')
    json_file = profiler.export_json('test_metrics.json')
    
    print(f"\nExported results:")
    print(f"  CSV: {csv_file}")
    print(f"  JSON: {json_file}")
    
    # Verify exports exist
    assert os.path.exists(csv_file), f"CSV file not created: {csv_file}"
    assert os.path.exists(json_file), f"JSON file not created: {json_file}"
    
    print("\n✅ System Profiler test passed!")
    
    return profiler


def test_performance_analyzer():
    """Test performance analyzer with generated data"""
    print("\n" + "="*80)
    print("Testing Performance Analyzer")
    print("="*80)
    
    from analyze_performance import PerformanceAnalyzer
    
    # Use the CSV file generated by test_system_profiler
    csv_file = 'performance_evaluation/results/test_metrics.csv'
    
    if not os.path.exists(csv_file):
        print(f"⚠️  CSV file not found: {csv_file}")
        print("Run test_system_profiler first or check file path")
        return
    
    print(f"\nLoading metrics from {csv_file}...")
    analyzer = PerformanceAnalyzer(csv_file=csv_file)
    
    # Identify bottlenecks
    print("\nIdentifying bottlenecks...")
    bottlenecks = analyzer.identify_bottlenecks()
    print(bottlenecks)
    
    # Generate report
    print("\nGenerating report...")
    report = analyzer.generate_report('performance_evaluation/results/test_report.txt')
    print(report)
    
    print("\n✅ Performance Analyzer test passed!")


def main():
    """Run all tests"""
    print("\n" + "="*80)
    print("PERFORMANCE EVALUATION TOOLS - TEST SUITE")
    print("="*80)
    
    try:
        # Test 1: System Profiler
        profiler = test_system_profiler()
        
        # Test 2: Performance Analyzer
        test_performance_analyzer()
        
        print("\n" + "="*80)
        print("✅ ALL TESTS PASSED!")
        print("="*80)
        print("\nYou can now use the performance evaluation tools:")
        print("  1. python performance_evaluation/pipeline_profiler.py --mode batch --duration 30")
        print("  2. python performance_evaluation/analyze_performance.py --input results/pipeline_profile_batch.csv")
        print("\nSee performance_evaluation/README.md for more information.")
        
    except Exception as e:
        print(f"\n❌ Test failed with error: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)


if __name__ == "__main__":
    main()
